<html>
<head>
	<title>スロット</title>
	<link rel="icon" type="image/png" href="blue.png">
</head>
<body>
<!-- 画像サイズは160x3680 -->
	<div id="result" align="center">スロットゲーム</div>
	<div id="money" align="right">所持コイン:50枚</div>
	<p id="state1" align="right"> </p>
	<p id="state2" align="right"> </p>
	<p id="state3" align="right"> </p>
	
	<img id="left" src="reel_left.png" style="left:200px;top:-1550px;clip:rect(1600,160,2080,0);position:absolute;"/>
	<img id="center" src="reel_center.png" style="left:360px;top:-1550px;clip:rect(1600,160,2080,0);position:absolute;">
	<img id="right" src="reel_right.png" style="left:520px;top:-1550px;clip:rect(1600,160,2080,0);position:absolute;">
	
	<button type="Button" OnClick="stop(1)" style="left:200px;top:550px;position:absolute;">Stop</button>
	<button type="Button" OnClick="stop(2)" style="left:360px;top:550px;position:absolute;">Stop</button>
	<button type="Button" OnClick="stop(3)" style="left:520px;top:550px;position:absolute;">Stop</button>
	
	<button type="Button" OnClick="start()" style="left:440px;top:600px;position:absolute;">Start!</button>
	
	<script>
	
		//現所持金
		var money=50;
		var use=3;
		
		var started=false;
		//止めるか判定
		var frag_left=false;
		var flag_center=false;
		var flag_right=false;
		
		//既に止まっているか判定
		var stop_left=false;
		var stop_center=false;
		var stop_right=false;
		
		//止める位置
		var end_left=0;
		var end_center=0;
		var end_right=0;
		
		var left=document.getElementById("left");
		var center=document.getElementById("center");
		var right=document.getElementById("right");
		
		//現在位置
		var cur_left=-1600;
		var cur_center=-1600;
		var cur_right=-1600;
		
		//速度指定
		var verocity_left=122*35/100.0;
		var verocity_center=-122*30/100.0;
		var verocity_right=122*32/100.0;
		
		onload=function(){
			money=input_money();
			money_update();
		}
		
		function input_money(){
			var ret=prompt("所持コインを入力してください。");
			return ret;
		}
		
		function money_update(){
			document.getElementById("money").innerHTML="所持コイン:"+money+"枚";
			return;
		}
		
		function start(){
			if(started){
				return;
			}
			
			document.getElementById("result").innerHTML="スロット";
			
			money-=use;
			if(money<0){
				use+=money;
				money=0;
			}
			money_update();
			
			//変数の初期化
			started=true;
			flag_left=flag_center=flag_right=false;
			stop_left=stop_center=stop_right=false;
			end_left=end_center=end_right=0;
			
			var left=document.getElementById("left");
			var center=document.getElementById("center");
			var right=document.getElementById("right");
		
			
			//境界判定に使用
			var bottom=160*20;
			
			var func=setInterval(function(){
				//現在位置の移動
				if(!stop_left){
					cur_left+=verocity_left;
				}
				if(!stop_center){
					cur_center+=verocity_center;
				}
				if(!stop_right){
					cur_right+=verocity_right;
				}
				
				//終了フラグが立っていて超えたなら止める
				if(flag_left&&cur_left>end_left){
					stop_left=true;
					cur_left=end_left;
				}
				if(flag_center&&cur_center<end_center){
					stop_center=true;
					cur_center=end_center;
				}
				if(flag_right&&cur_right>end_right){
					stop_right=true;
					cur_right=end_right;
				}
				
				//境界を超えていたら元に戻す
				if(cur_left>=0){
					cur_left=-bottom;
				}
				if(cur_center<=-bottom){
					cur_center=0;				
				}
				if(cur_right>=0){
					cur_right=-bottom;
				}
				
				//移動の適用
				left.style.top=cur_left+50+"px";
				left.style.clip="rect("+(-cur_left)+",160,"+(-cur_left+480)+",0)";
				center.style.top=cur_center+50+"px";
				center.style.clip="rect("+(-cur_center)+",160,"+(-cur_center+480)+",0)";
				right.style.top=cur_right+50+"px";
				right.style.clip="rect("+(-cur_right)+",160,"+(-cur_right+480)+",0)";
				
				if(stop_left&&stop_center&&stop_right){
					//終了処理
					end();
					money_update();
					if(money<=0){
						document.getElementById("result").innerHTML+="	GAMEOVER";
						setTimeout(10000,input_money());
					}
					started=false;
					clearInterval(func);
					return;
				}
			},10);
		}
		
		function stop(num){
			if(num==1){
				//leftを止める
				flag_left=true;
				var move=(-cur_left)%160;
				end_left=cur_left+move;
			}
			else if(num==2){
				//centerを止める
				flag_center=true;
				var move=(160*20+cur_center)%160;
				end_center=cur_center-move;
			}
			else if(num==3){
				//rightを止める
				flag_right=true;
				var move=(-cur_right)%160;
				end_right=cur_right+move;
			}
			return;
		}
		
		function end(){
			/*
			left: rep(0)			0,5,8,10,15
					banana(1)		1,6,11,16
					watermelon(2)	3,9,17,19
					orange(3)		7,18
					cherry(4)		13,14
					bar(5)			12
					seven(6)			2,4
			*/
			var array_left=[0,1,6,2,6,0,1,3,0,2,0,1,5,4,4,0,1,2,3,2,0];
			var up_left=Math.floor(-cur_left/160);
			var mid_left=array_left[(up_left+1)%20],low_left=array_left[(up_left+2)%20];
			up_left=array_left[up_left];
			/*
			center:	rep(0)			1,6,11,16
						banana(1)		2,7,12,17
						watermelon(2)	0,5,10
						orange(3)		8,18
						cherry(4)		9,13,15,19
						bar(5)			14
						seven(6)			3,4
			*/
			var array_center=[2,0,1,6,6,2,0,1,3,4,2,0,1,4,5,4,0,1,3,4,2];
			var up_center=Math.floor(-cur_center/160);
			var mid_center=array_center[(up_center+1)%20],low_center=array_center[(up_center+2)%20];
			up_center=array_center[up_center];
			/*
			right:	rep(0)			2,7,12,17
						banana(1)		1,6,11,16
						watermelon(2)	3,8,13,18
						orange(3)		9,19
						cherry(4)		0,5,10,15
						bar(5)			14
						seven(6)			4
			*/
			var array_right=[4,1,0,2,6,4,1,0,2,3,4,1,0,2,5,4,1,0,2,3,4];
			var up_right=Math.floor(-cur_right/160);
			var mid_right=array_right[(up_right+1)%20],low_right=array_right[(up_right+2)%20];
			up_right=array_right[up_right];
			
			document.getElementById("state1").innerHTML=up_left+" "+up_center+" "+up_right;
			document.getElementById("state2").innerHTML=mid_left+" "+mid_center+" "+mid_right;
			document.getElementById("state3").innerHTML=low_left+" "+low_center+" "+low_right;
			
			//mid-mid-mid
			if(equals(mid_left,mid_center,mid_right)){
				if(mid_left==0)	replay();
				else if(mid_left>=5)	bonus(mid_left);
				else	fluit(mid_left);
			}
			//up-up-up
			else if(equals(up_left,up_center,up_right)){
				if(up_left==0)	replay();
				else if(up_left>=5)	bonus(up_left);
				else	fluit(up_left);
			}
			//low-low-low
			else if(equals(low_left,low_center,low_right)){
				if(low_left==0)	replay();
				else if(low_left>=5)	bonus(low_left);
				else	fluit(low_left);
			}
			//up-mid-low
			else if(equals(up_left,mid_center,low_right)){
				if(up_left==0)	replay();
				else if(up_left>=5)	bonus(up_left);
				else	fluit(up_left);
			}
			//low-mid-up
			else if(equals(low_left,mid_center,up_right)){
				if(low_left==0)	replay();
				else if(low_left>=5)	bonus(low_left);
				else	fluit(low_left);
			}
			else {
				document.getElementById("result").innerHTML="残念!!はずれ!!!";
			}
			return;
		}
		
		function equals(a,b,c){
			return (a==b&&b==c?true:false);
		}		
		/*
			rep:0
			banana:1
			watermelon:2
			orange:3
			cherry:4
			bar:5
			seven:6
		*/
		function replay(){
			document.getElementById("result").innerHTML="リプレイ";
			started=false;
			setTimeout(start(),10000);
			return;
		}
		
		function fluit(num){
			var str=["バナナ","スイカ","オレンジ","チェリー"];
			document.getElementById("result").innerHTML=str[num-1]+"が当たりました。"+use*5+"枚獲得。";
			money+=use*5;	use=3;
			return;
		}
		
		function bonus(num){
			document.getElementById("result").innerHTML="大当たり!!!"+use*20+"枚獲得。";
			money+=use*20;			
			//モードチェンジの処理
			return;
		}
	</script>
</body>